<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Promise 和 async/await | FE 前端研究所</title>
    <meta name="description" content="ErrorJE 直辖 Blog | FE 前端研究所">
    <link rel="icon" href="/logo.jpg">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    
    <link rel="preload" href="/assets/css/0.styles.99fee6bc.css" as="style"><link rel="preload" href="/assets/js/app.9e5917f5.js" as="script"><link rel="preload" href="/assets/js/2.6d170185.js" as="script"><link rel="preload" href="/assets/js/26.c9172401.js" as="script"><link rel="prefetch" href="/assets/js/10.ee1c1979.js"><link rel="prefetch" href="/assets/js/100.f31985c5.js"><link rel="prefetch" href="/assets/js/101.e1a418b9.js"><link rel="prefetch" href="/assets/js/102.4b2610e7.js"><link rel="prefetch" href="/assets/js/11.2d3a5c7c.js"><link rel="prefetch" href="/assets/js/12.8e99710f.js"><link rel="prefetch" href="/assets/js/13.27e3f10f.js"><link rel="prefetch" href="/assets/js/14.514ef364.js"><link rel="prefetch" href="/assets/js/15.9717a3ce.js"><link rel="prefetch" href="/assets/js/16.eb42bdaa.js"><link rel="prefetch" href="/assets/js/17.dd0bd8ce.js"><link rel="prefetch" href="/assets/js/18.7c11f606.js"><link rel="prefetch" href="/assets/js/19.ec498a89.js"><link rel="prefetch" href="/assets/js/20.60f1a8a8.js"><link rel="prefetch" href="/assets/js/21.c25bfdec.js"><link rel="prefetch" href="/assets/js/22.dbe12b43.js"><link rel="prefetch" href="/assets/js/23.a0cb54ad.js"><link rel="prefetch" href="/assets/js/24.dad8f402.js"><link rel="prefetch" href="/assets/js/25.6c58262c.js"><link rel="prefetch" href="/assets/js/27.d8463591.js"><link rel="prefetch" href="/assets/js/28.2ba1e72e.js"><link rel="prefetch" href="/assets/js/29.705178f1.js"><link rel="prefetch" href="/assets/js/3.e21bb9ed.js"><link rel="prefetch" href="/assets/js/30.156c6952.js"><link rel="prefetch" href="/assets/js/31.3ace218a.js"><link rel="prefetch" href="/assets/js/32.f9ccb391.js"><link rel="prefetch" href="/assets/js/33.e4d3e853.js"><link rel="prefetch" href="/assets/js/34.c5adedab.js"><link rel="prefetch" href="/assets/js/35.43e31ae5.js"><link rel="prefetch" href="/assets/js/36.d84a5d2e.js"><link rel="prefetch" href="/assets/js/37.7d9a7967.js"><link rel="prefetch" href="/assets/js/38.b8b67fe7.js"><link rel="prefetch" href="/assets/js/39.b6e131dd.js"><link rel="prefetch" href="/assets/js/4.bdffc1b6.js"><link rel="prefetch" href="/assets/js/40.5278289f.js"><link rel="prefetch" href="/assets/js/41.302b5328.js"><link rel="prefetch" href="/assets/js/42.736df250.js"><link rel="prefetch" href="/assets/js/43.dfc18400.js"><link rel="prefetch" href="/assets/js/44.bdf4cd45.js"><link rel="prefetch" href="/assets/js/45.8440854f.js"><link rel="prefetch" href="/assets/js/46.978b71d6.js"><link rel="prefetch" href="/assets/js/47.33aabefb.js"><link rel="prefetch" href="/assets/js/48.6701ef33.js"><link rel="prefetch" href="/assets/js/49.6941dbdb.js"><link rel="prefetch" href="/assets/js/5.8b0953b8.js"><link rel="prefetch" href="/assets/js/50.b36bcf99.js"><link rel="prefetch" href="/assets/js/51.15699984.js"><link rel="prefetch" href="/assets/js/52.c7da722e.js"><link rel="prefetch" href="/assets/js/53.db0735be.js"><link rel="prefetch" href="/assets/js/54.2b671e6d.js"><link rel="prefetch" href="/assets/js/55.71b13354.js"><link rel="prefetch" href="/assets/js/56.0ff4a596.js"><link rel="prefetch" href="/assets/js/57.a613fdd5.js"><link rel="prefetch" href="/assets/js/58.04cee869.js"><link rel="prefetch" href="/assets/js/59.6a406603.js"><link rel="prefetch" href="/assets/js/6.4336baf3.js"><link rel="prefetch" href="/assets/js/60.0a33d8d5.js"><link rel="prefetch" href="/assets/js/61.8007b995.js"><link rel="prefetch" href="/assets/js/62.75c8391d.js"><link rel="prefetch" href="/assets/js/63.cd8b9ee8.js"><link rel="prefetch" href="/assets/js/64.c954a922.js"><link rel="prefetch" href="/assets/js/65.7842542e.js"><link rel="prefetch" href="/assets/js/66.80a274a1.js"><link rel="prefetch" href="/assets/js/67.7c1e35a0.js"><link rel="prefetch" href="/assets/js/68.db994f15.js"><link rel="prefetch" href="/assets/js/69.f64b7345.js"><link rel="prefetch" href="/assets/js/7.da34982c.js"><link rel="prefetch" href="/assets/js/70.449023c5.js"><link rel="prefetch" href="/assets/js/71.0d9de4be.js"><link rel="prefetch" href="/assets/js/72.1d05f05b.js"><link rel="prefetch" href="/assets/js/73.46e686b2.js"><link rel="prefetch" href="/assets/js/74.0fd55c32.js"><link rel="prefetch" href="/assets/js/75.f4dc152e.js"><link rel="prefetch" href="/assets/js/76.b43bb599.js"><link rel="prefetch" href="/assets/js/77.b24ddfb7.js"><link rel="prefetch" href="/assets/js/78.3a82b014.js"><link rel="prefetch" href="/assets/js/79.66e8bf47.js"><link rel="prefetch" href="/assets/js/8.5f8f0f1a.js"><link rel="prefetch" href="/assets/js/80.a90c418a.js"><link rel="prefetch" href="/assets/js/81.2386d012.js"><link rel="prefetch" href="/assets/js/82.b6108b1b.js"><link rel="prefetch" href="/assets/js/83.05df04e0.js"><link rel="prefetch" href="/assets/js/84.7e37ba22.js"><link rel="prefetch" href="/assets/js/85.b7b87f39.js"><link rel="prefetch" href="/assets/js/86.26e1d68d.js"><link rel="prefetch" href="/assets/js/87.1e5b732c.js"><link rel="prefetch" href="/assets/js/88.c9040b0a.js"><link rel="prefetch" href="/assets/js/89.6a2abc14.js"><link rel="prefetch" href="/assets/js/9.7a222e22.js"><link rel="prefetch" href="/assets/js/90.60370538.js"><link rel="prefetch" href="/assets/js/91.83bd8f62.js"><link rel="prefetch" href="/assets/js/92.73176f25.js"><link rel="prefetch" href="/assets/js/93.b46d9e51.js"><link rel="prefetch" href="/assets/js/94.29b46bfd.js"><link rel="prefetch" href="/assets/js/95.dc7119dc.js"><link rel="prefetch" href="/assets/js/96.43683cd6.js"><link rel="prefetch" href="/assets/js/97.9c03ce8a.js"><link rel="prefetch" href="/assets/js/98.45edf25a.js"><link rel="prefetch" href="/assets/js/99.320ef7b0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.99fee6bc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">FE 前端研究所</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端初级" class="dropdown-title"><span class="title">前端初级</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>HTML / CSS</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/p4/html-base/" class="nav-link">HTML 基础</a></li><li class="dropdown-subitem"><a href="/p4/html-pro/" class="nav-link">HTML5</a></li><li class="dropdown-subitem"><a href="/p4/css-base/" class="nav-link">CSS 基础</a></li><li class="dropdown-subitem"><a href="/p4/css-pro/" class="nav-link">CSS3 / CSS4</a></li></ul></li><li class="dropdown-item"><h4>JS 基础与进阶</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/p4/javascript/" class="nav-link">JavaScript</a></li><li class="dropdown-subitem"><a href="/p4/es-next/01 let 变量和 const 常量.html" class="nav-link">ES-Next</a></li><li class="dropdown-subitem"><a href="/p4/typescript/00 基础知识.html" class="nav-link">TypeScript</a></li><li class="dropdown-subitem"><a href="/p4/jquery/" class="nav-link">JQuery</a></li><li class="dropdown-subitem"><a href="/p4/browser/DOM.html" class="nav-link">浏览器原理</a></li></ul></li><li class="dropdown-item"><h4>项目包管理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/p4/package/npm/" class="nav-link">NPM</a></li><li class="dropdown-subitem"><a href="/p4/package/yarn/" class="nav-link">YARN</a></li><li class="dropdown-subitem"><a href="/p4/package/learn/" class="nav-link">LEARN</a></li></ul></li><li class="dropdown-item"><h4>团队协作</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/p4/team/code-format/" class="nav-link">代码规范</a></li><li class="dropdown-subitem"><a href="/p4/team/tools/" class="nav-link">开发工具链</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端中级" class="dropdown-title"><span class="title">前端中级</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>移动端开发</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/p5/web-app/h5/" class="nav-link">H5</a></li><li class="dropdown-subitem"><a href="/p5/web-app/uni-app/" class="nav-link">Uni-App</a></li><li class="dropdown-subitem"><a href="/p5/web-app/react-native/" class="nav-link">React Native</a></li><li class="dropdown-subitem"><a href="/p5/web-app/fullter/" class="nav-link">Fullter</a></li><li class="dropdown-subitem"><a href="/p5/web-app/wechat/" class="nav-link">微信小程序</a></li><li class="dropdown-subitem"><a href="/p5/web-app/weex/" class="nav-link">Weex</a></li><li class="dropdown-subitem"><a href="/p5/web-app/mpvue/" class="nav-link">MpVue</a></li><li class="dropdown-subitem"><a href="/p5/web-app/pwa/" class="nav-link">PWA</a></li><li class="dropdown-subitem"><a href="/p5/web-app/native-app/" class="nav-link">Native App</a></li><li class="dropdown-subitem"><a href="/p5/web-app/hybird-app/" class="nav-link">Hybird App</a></li></ul></li><li class="dropdown-item"><h4>开发框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/p5/vue-base/" class="nav-link">Vue</a></li><li class="dropdown-subitem"><a href="/p5/vue-element-admin/" class="nav-link">Vue-Element-Admin</a></li><li class="dropdown-subitem"><a href="/p5/react-base/" class="nav-link">React</a></li></ul></li><li class="dropdown-item"><h4>NodeJS</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/p5/node-js/node-base/" class="nav-link">Node 基础</a></li><li class="dropdown-subitem"><a href="/p5/node-js/express.html" class="nav-link">Express</a></li><li class="dropdown-subitem"><a href="/p5/node-js/koa.html" class="nav-link">Koa</a></li></ul></li><li class="dropdown-item"><h4>面试相关</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/p5/interview/business/" class="nav-link">业务开发</a></li><li class="dropdown-subitem"><a href="/p5/interview/topic/" class="nav-link">面试题</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/live/" class="nav-link">记录</a></li><li class="dropdown-item"><!----> <a href="/blog/economics/" class="nav-link">经济学</a></li><li class="dropdown-item"><!----> <a href="/blog/growth/" class="nav-link">程序员成长</a></li></ul></div></div><div class="nav-item"><a href="/my-resume.html" class="nav-link">Resume</a></div> <a href="https://github.com/ErrorJe/whole-stack-note" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端初级" class="dropdown-title"><span class="title">前端初级</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>HTML / CSS</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/p4/html-base/" class="nav-link">HTML 基础</a></li><li class="dropdown-subitem"><a href="/p4/html-pro/" class="nav-link">HTML5</a></li><li class="dropdown-subitem"><a href="/p4/css-base/" class="nav-link">CSS 基础</a></li><li class="dropdown-subitem"><a href="/p4/css-pro/" class="nav-link">CSS3 / CSS4</a></li></ul></li><li class="dropdown-item"><h4>JS 基础与进阶</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/p4/javascript/" class="nav-link">JavaScript</a></li><li class="dropdown-subitem"><a href="/p4/es-next/01 let 变量和 const 常量.html" class="nav-link">ES-Next</a></li><li class="dropdown-subitem"><a href="/p4/typescript/00 基础知识.html" class="nav-link">TypeScript</a></li><li class="dropdown-subitem"><a href="/p4/jquery/" class="nav-link">JQuery</a></li><li class="dropdown-subitem"><a href="/p4/browser/DOM.html" class="nav-link">浏览器原理</a></li></ul></li><li class="dropdown-item"><h4>项目包管理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/p4/package/npm/" class="nav-link">NPM</a></li><li class="dropdown-subitem"><a href="/p4/package/yarn/" class="nav-link">YARN</a></li><li class="dropdown-subitem"><a href="/p4/package/learn/" class="nav-link">LEARN</a></li></ul></li><li class="dropdown-item"><h4>团队协作</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/p4/team/code-format/" class="nav-link">代码规范</a></li><li class="dropdown-subitem"><a href="/p4/team/tools/" class="nav-link">开发工具链</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端中级" class="dropdown-title"><span class="title">前端中级</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>移动端开发</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/p5/web-app/h5/" class="nav-link">H5</a></li><li class="dropdown-subitem"><a href="/p5/web-app/uni-app/" class="nav-link">Uni-App</a></li><li class="dropdown-subitem"><a href="/p5/web-app/react-native/" class="nav-link">React Native</a></li><li class="dropdown-subitem"><a href="/p5/web-app/fullter/" class="nav-link">Fullter</a></li><li class="dropdown-subitem"><a href="/p5/web-app/wechat/" class="nav-link">微信小程序</a></li><li class="dropdown-subitem"><a href="/p5/web-app/weex/" class="nav-link">Weex</a></li><li class="dropdown-subitem"><a href="/p5/web-app/mpvue/" class="nav-link">MpVue</a></li><li class="dropdown-subitem"><a href="/p5/web-app/pwa/" class="nav-link">PWA</a></li><li class="dropdown-subitem"><a href="/p5/web-app/native-app/" class="nav-link">Native App</a></li><li class="dropdown-subitem"><a href="/p5/web-app/hybird-app/" class="nav-link">Hybird App</a></li></ul></li><li class="dropdown-item"><h4>开发框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/p5/vue-base/" class="nav-link">Vue</a></li><li class="dropdown-subitem"><a href="/p5/vue-element-admin/" class="nav-link">Vue-Element-Admin</a></li><li class="dropdown-subitem"><a href="/p5/react-base/" class="nav-link">React</a></li></ul></li><li class="dropdown-item"><h4>NodeJS</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/p5/node-js/node-base/" class="nav-link">Node 基础</a></li><li class="dropdown-subitem"><a href="/p5/node-js/express.html" class="nav-link">Express</a></li><li class="dropdown-subitem"><a href="/p5/node-js/koa.html" class="nav-link">Koa</a></li></ul></li><li class="dropdown-item"><h4>面试相关</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/p5/interview/business/" class="nav-link">业务开发</a></li><li class="dropdown-subitem"><a href="/p5/interview/topic/" class="nav-link">面试题</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/live/" class="nav-link">记录</a></li><li class="dropdown-item"><!----> <a href="/blog/economics/" class="nav-link">经济学</a></li><li class="dropdown-item"><!----> <a href="/blog/growth/" class="nav-link">程序员成长</a></li></ul></div></div><div class="nav-item"><a href="/my-resume.html" class="nav-link">Resume</a></div> <a href="https://github.com/ErrorJe/whole-stack-note" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/p4/es-next/01 块级作用域.html" class="sidebar-link">块级作用域</a></li><li><a href="/p4/es-next/02 数值的新特性.html" class="sidebar-link">数值的新特性</a></li><li><a href="/p4/es-next/03 字符串的新特性.html" class="sidebar-link">字符串的新特性</a></li><li><a href="/p4/es-next/04 数组的新特性.html" class="sidebar-link">数组的新特性</a></li><li><a href="/p4/es-next/05 对象的新特性.html" class="sidebar-link">对象的新特性</a></li><li><a href="/p4/es-next/06 函数的新特性.html" class="sidebar-link">函数的新特性</a></li><li><a href="/p4/es-next/07 解构赋值（脱壳）.html" class="sidebar-link">解构赋值 destructure（脱壳）</a></li><li><a href="/p4/es-next/08 class 类.html" class="sidebar-link">class 类</a></li><li><a href="/p4/es-next/09 Set 和 Map 数据结构.html" class="sidebar-link">Set 和 Map 数据结构</a></li><li><a href="/p4/es-next/10 Promise 和 async_await.html" class="active sidebar-link">Promise 和 async/await</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#promise-原生使用" class="sidebar-link">Promise 原生使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#引入-promise-和基本使用" class="sidebar-link">引入 promise 和基本使用</a></li><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#promise-的三种状态" class="sidebar-link">Promise 的三种状态</a></li><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#promise-其他方法的使用（all-race）" class="sidebar-link">Promise 其他方法的使用（all, race）</a></li></ul></li><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#promise-源码实现" class="sidebar-link">Promise 源码实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#promise-实现类" class="sidebar-link">Promise 实现类</a></li><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#解析-promise-方法" class="sidebar-link">解析 promise 方法</a></li><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#then-方法" class="sidebar-link">then 方法</a></li><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#all-和-race-方法" class="sidebar-link">all 和 race 方法</a></li><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#deferred-和-catch-方法" class="sidebar-link">deferred 和 catch 方法</a></li><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#resolve-和-reject-方法" class="sidebar-link">resolve 和 reject 方法</a></li></ul></li><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#node-模块-q" class="sidebar-link">node 模块 q</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#q-的基本用法" class="sidebar-link">q 的基本用法</a></li><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#自定义-q" class="sidebar-link">自定义 Q</a></li><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#自定义-promise-原生-promise-q-的混合使用" class="sidebar-link">自定义 promise + 原生 promise + Q 的混合使用</a></li></ul></li><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#bluebird-最快的promise" class="sidebar-link">bluebird - 最快的promise</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#基本用法" class="sidebar-link">基本用法</a></li><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#其他用法" class="sidebar-link">其他用法</a></li></ul></li><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#genarator-promise" class="sidebar-link">genarator + promise</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#原生的方式" class="sidebar-link">原生的方式</a></li><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#使用-co-库来自动调用迭代器" class="sidebar-link">使用 co 库来自动调用迭代器</a></li></ul></li><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#async-await-异步终极解决方案" class="sidebar-link">async await 异步终极解决方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#基本使用方式" class="sidebar-link">基本使用方式</a></li><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#语法糖的实现原理" class="sidebar-link">语法糖的实现原理</a></li></ul></li><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#多种异步方式实现的demo" class="sidebar-link">多种异步方式实现的demo</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#回调嵌套" class="sidebar-link">回调嵌套</a></li><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#promise-链式调用" class="sidebar-link">promise 链式调用</a></li><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#generator-promise" class="sidebar-link">generator + promise</a></li><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#async-await" class="sidebar-link">async await</a></li></ul></li><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#补充知识" class="sidebar-link">补充知识</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#迭代器" class="sidebar-link">迭代器</a></li><li class="sidebar-sub-header"><a href="/p4/es-next/10 Promise 和 async_await.html#深度克隆" class="sidebar-link">深度克隆</a></li></ul></li></ul></li><li><a href="/p4/es-next/11 Proxy 和 Reflect 代理对象.html" class="sidebar-link">Proxy 和 Reflect 代理对象</a></li><li><a href="/p4/es-next/12 Generator 异步迭代器.html" class="sidebar-link">Generator 异步迭代器</a></li><li><a href="/p4/es-next/13 前端模块化.html" class="sidebar-link">前端模块化</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="promise-和-async-await"><a href="#promise-和-async-await" class="header-anchor">#</a> Promise 和 async/await</h1> <h2 id="promise-原生使用"><a href="#promise-原生使用" class="header-anchor">#</a> Promise 原生使用</h2> <p>Promise 是承诺的意思。一般指异步任务，需要很长时间执行的任务。在ES6中已经原生内嵌了 Promise/A+标准。</p> <blockquote><p>这里我们手写一个promise源码，然后进行操作。实现跟使用原生一样的效果</p></blockquote> <h3 id="引入-promise-和基本使用"><a href="#引入-promise-和基本使用" class="header-anchor">#</a> 引入 promise 和基本使用</h3> <blockquote><p>当然，原生中是不用特意引用。ES6是支持的。
Promise 有2个回调，分别是成功时调用 resolve， 和失败时调用 reject
promise.then(onFulfilled, onRejected)， 分别对应处理 成功回调 和 失败回调。</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 引入自定义的 promise</span>
<span class="token keyword">let</span> MyPromise <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./Promise'</span><span class="token punctuation">)</span>

<span class="token comment">// Promise 表示一个异步操作的最终结果。同时 promise 也是个对象。</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 用 setTimeout 模仿异步操作</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> num <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 随机数判断</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">&gt;</span> <span class="token number">.5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'成功'</span><span class="token punctuation">)</span> <span class="token comment">// 成功时调用, fulfilled 状态</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'失败'</span><span class="token punctuation">)</span> <span class="token comment">// 失败时调用, rejected 状态</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 要取到回调中的结果，就要用到 Promise.then</span>
p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 成功回调。value 拿到的是从 resolve 回调中传来的数据</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'成功回调'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 失败回调。从 reject 回调中传来的数据</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'失败回调'</span><span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="promise-的三种状态"><a href="#promise-的三种状态" class="header-anchor">#</a> Promise 的三种状态</h3> <ul><li>pending 初始态。可以转换成 成功或失败 的状态 。去 then 中找他们。</li> <li>fulfilled 结果：成功态， value:  成功结果</li> <li>rejected 结果：失败态， reason： 失败原因</li></ul> <h3 id="promise-其他方法的使用（all-race）"><a href="#promise-其他方法的使用（all-race）" class="header-anchor">#</a> Promise 其他方法的使用（all, race）</h3> <blockquote><p>这两个方法都属于类，而不是实例。可以接收 Promise 数组。
promise.all([]) 若全部完成，promise才算成功。一个失败，就整个失败。
promise.race([]) 只看那个最先完成的结果。它的结果决定整组的结果。</p></blockquote> <ul><li>定义2个promise对象</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'p1失败'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>执行 promise.all</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'cost2'</span><span class="token punctuation">)</span>

<span class="token comment">// 同时异步请求多个数据， 用 all</span>
Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [1, 2]调用顺序</span>
  console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span> <span class="token comment">// 2s。取决于最慢的那个</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost2'</span><span class="token punctuation">)</span> <span class="token comment">// 1s, p1失败</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>执行 promise.race</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 当你有3个接口都不稳定，可同时取3个，谁先回来用谁的</span>
Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span> <span class="token comment">// 1s</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost2'</span><span class="token punctuation">)</span> <span class="token comment">// 1s, p1失败</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="promise-源码实现"><a href="#promise-源码实现" class="header-anchor">#</a> Promise 源码实现</h2> <blockquote><p>将 promise 封装成模块来使用</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// ...</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Promise
</code></pre></div><blockquote><p>把三种状态设定为常量</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 定义三种状态的常量 </span>
<span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'pending'</span>
<span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'fulfilled'</span>
<span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'rejected'</span>
</code></pre></div><h3 id="promise-实现类"><a href="#promise-实现类" class="header-anchor">#</a> Promise 实现类</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 定义个 promise 实现类。构造函数的参数是一个异步任务</span>
<span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span> <span class="token comment">// 缓存this, 绑定 promise 实例</span>
  that<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">PENDING</span> <span class="token comment">// 默认状态为 pending</span>
  that<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span> <span class="token comment">// 放 promise 结果，可以放 成功或失败 的结果</span>
  that<span class="token punctuation">.</span>onResolvedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 存放所有成功的回调函数， 放一些承诺</span>
  that<span class="token punctuation">.</span>onRejectedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 存放所有失败的回调函数， 放一些理由</span>

  <span class="token comment">// 把 promise 状态改为成功态</span>
  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 若是初始态，则转为成功态</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>that<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        that<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">FULFILLED</span>
        that<span class="token punctuation">.</span>value <span class="token operator">=</span> value <span class="token comment">// 成功后得到值，且不能修改</span>
        <span class="token comment">// 调用所有成功的回调</span>
        that<span class="token punctuation">.</span>onResolvedCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token function">cb</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 把 promise 状态改为失败态</span>
  <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 若当前状态是初始态，则改为 失败态</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>that<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      that<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">REJECTED</span>
      that<span class="token punctuation">.</span>value <span class="token operator">=</span> reason
      that<span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token function">cb</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 立即执行传入的任务 executor</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 因为此函数执行可能会异常，所以需要捕获。若出错，则用错误对象 reject</span>
    <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 若此函数执行失败，则用失败的原因 reject 这个 promise</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="解析-promise-方法"><a href="#解析-promise-方法" class="header-anchor">#</a> 解析 promise 方法</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 解析promise</span>
<span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1 promise2 和 x(promise1返回值) 指向同一个对象的情况</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>promise2 <span class="token operator">===</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'循环引用'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> called <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// promise2 是否已经 resolve 或者 reject了</span>
  <span class="token comment">// 2 当 promise1 返回的是另一个 promise 对象时</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// y 是 x 的值</span>
        <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3 当 x 为thenable函数或对象时, 只要有 then 方法的对象</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">==</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当我们的 promise 和别的 promise 进行交互。这段代码要考虑兼容性，允许别人乱写</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> then <span class="token operator">=</span> x<span class="token punctuation">.</span>then
      <span class="token comment">// 3.1 若 then 是个函数</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 若promise2 已经成功或失败了，则不会再处理</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span>
          called <span class="token operator">=</span> <span class="token boolean">true</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span>
          called <span class="token operator">=</span> <span class="token boolean">true</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// 3.2 若是个对象</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 到此的话 x 不是一个 thenable 对象，那直接把它当成值 resolve promise2就行了</span>
        <span class="token comment">// 即返回的是一个对象 {key:Value, then:{}}， 有then属性但不是函数</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span>
      called <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 4 若 x 是一个普通值，则用 x 的值去 resolve promise2</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="then-方法"><a href="#then-方法" class="header-anchor">#</a> then 方法</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// onFulfilled 成功回调。用来接收 promise 成功的值或者是失败的原因</span>
<span class="token comment">// onRejected 失败回调</span>
<span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 若成功和失败的回调没有传，则表示这个 then 没有任何逻辑，即 p.then()</span>
  <span class="token comment">// 此时，会给一个默认值。就是在返回这个 promise1 时resolve(data)抛出的值</span>
  <span class="token comment">// 然后将这个值传递给 promise2</span>
  onFulfilled <span class="token operator">=</span> <span class="token keyword">typeof</span> onFulfille <span class="token operator">==</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onFulfilled</span> <span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> value
  <span class="token punctuation">}</span>
  <span class="token comment">// 若 promise1 失败了</span>
  onRejected <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejected <span class="token operator">==</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onRejected</span> <span class="token operator">:</span> <span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> reason
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
  <span class="token keyword">let</span> promise2
  <span class="token comment">// 同步时，走这2个分支</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>that<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'同步&gt;&gt;&gt;'</span><span class="token punctuation">,</span> <span class="token string">'FULFILLED'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 若当前 promise状态已经是成功态了，返回一个新的 Promise</span>
    <span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token comment">// onFulfilled 直接取值</span>
          <span class="token comment">// 若获取到了返回值 x， 走解析promise的过程</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 若执行成功的回调过程中, 方法出异常时，用错误原因把promise2 reject</span>
          <span class="token comment">// 即链式调用中，promise1-成功回调出错时，去到promise2的失败回调中</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>that<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'同步&gt;&gt;&gt;'</span><span class="token punctuation">,</span> <span class="token string">'REJECTED'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 异步时走这个分支</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>that<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'异步&gt;&gt;&gt;'</span><span class="token punctuation">,</span> <span class="token string">'PENDING'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      that<span class="token punctuation">.</span>onResolvedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      that<span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="all-和-race-方法"><a href="#all-和-race-方法" class="header-anchor">#</a> all 和 race 方法</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 工厂函数</span>
<span class="token keyword">function</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token parameter">times<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">i<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> data
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>count <span class="token operator">==</span> times<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">cb</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Promise<span class="token punctuation">.</span><span class="token function-variable function">all</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> done <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span>promises<span class="token punctuation">.</span>length<span class="token punctuation">,</span> resolve<span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// promises[i].then(done.bind(null, i))</span>
      promises<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">done</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

Promise<span class="token punctuation">.</span><span class="token function-variable function">race</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      promises<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="deferred-和-catch-方法"><a href="#deferred-和-catch-方法" class="header-anchor">#</a> deferred 和 catch 方法</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// catch 原理就是只传失败的回调</span>
<span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">catch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

Promise<span class="token punctuation">.</span>deferred <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function-variable function">defer</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> defer <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 延迟对象</span>
  defer<span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    defer<span class="token punctuation">.</span>resolve <span class="token operator">=</span> resolve
    defer<span class="token punctuation">.</span>reject <span class="token operator">=</span> reject
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> defer
<span class="token punctuation">}</span>
</code></pre></div><h3 id="resolve-和-reject-方法"><a href="#resolve-和-reject-方法" class="header-anchor">#</a> resolve 和 reject 方法</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 返回一个立即成功的 promise</span>
<span class="token comment">// 别人提供给你一个方法，需要你传入一个promise， 但是你只有一个普通的值，你就可以通过这个方法把这个普通的值(String, number, object)转成一个promise对象</span>
Promise<span class="token punctuation">.</span><span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 返回一个立即失败的 promise</span>
Promise<span class="token punctuation">.</span><span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="node-模块-q"><a href="#node-模块-q" class="header-anchor">#</a> node 模块 q</h2> <blockquote><p>q 用来实现 promise， 在angularjs中用的就是q
q 是node的一个模块。是 promise 的另外一种实现方式
实际上这是比较老的实现方式，在JQ中也有</p></blockquote> <h3 id="q-的基本用法"><a href="#q-的基本用法" class="header-anchor">#</a> q 的基本用法</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> <span class="token constant">Q</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'q'</span><span class="token punctuation">)</span> <span class="token comment">// 引入 q 库</span>
<span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> defer <span class="token operator">=</span> <span class="token constant">Q</span><span class="token punctuation">.</span><span class="token function">defer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 返回 defer 对象</span>
  fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      defer<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      defer<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> defer<span class="token punctuation">.</span>promise
<span class="token punctuation">}</span>
<span class="token comment">// 调用</span>
<span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./1.txt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="自定义-q"><a href="#自定义-q" class="header-anchor">#</a> 自定义 Q</h3> <blockquote><p>就可以直接使用 Q.defer 不用去引入原生的 q</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 自定义一个Q</span>
<span class="token keyword">let</span> <span class="token constant">Q</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">defer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> success<span class="token punctuation">,</span> error
    <span class="token comment">// 返回个对象,里面有2个方法，一个promise对象</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 成功回调</span>
        <span class="token function">success</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 失败回调</span>
        <span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      promise<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          success <span class="token operator">=</span> onFulfilled
          error <span class="token operator">=</span> onRejected
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="自定义-promise-原生-promise-q-的混合使用"><a href="#自定义-promise-原生-promise-q-的混合使用" class="header-anchor">#</a> 自定义 promise + 原生 promise + Q 的混合使用</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/* 自定义promise， 原生promise， q 混合使用 */</span>
<span class="token keyword">let</span> MyPromise <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./Promise'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> <span class="token constant">Q</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'q'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 返回原生的 promise</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>data <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment">// 200</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 调用 q</span>
<span class="token keyword">let</span> p3 <span class="token operator">=</span> p2<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> defer <span class="token operator">=</span> <span class="token constant">Q</span><span class="token punctuation">.</span><span class="token function">defer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  defer<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>data <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment">// 300</span>
  <span class="token keyword">return</span> defer<span class="token punctuation">.</span>promise
<span class="token punctuation">}</span><span class="token punctuation">)</span>
p3<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 300</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Q.all 使用</span>
<span class="token keyword">function</span> <span class="token function">eventAdd</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Q.spread扩展的意思,[]中的元素分别传给后面回调函数的参数</span>
  <span class="token keyword">return</span> <span class="token constant">Q</span><span class="token punctuation">.</span><span class="token function">spread</span><span class="token punctuation">(</span><span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a <span class="token operator">+</span> b
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> r <span class="token operator">=</span> <span class="token constant">Q</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token function">eventAdd</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token function">eventAdd</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
r<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [4, 30]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="bluebird-最快的promise"><a href="#bluebird-最快的promise" class="header-anchor">#</a> bluebird - 最快的promise</h2> <blockquote><p>bluebird 是世界上最快的promise库。 比ES6 promise出现更早
它能把任意的通过回调函数实现异步API换成promise API</p></blockquote> <h3 id="基本用法"><a href="#基本用法" class="header-anchor">#</a> 基本用法</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> Promise <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bluebird'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> readFile <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>readFile

<span class="token comment">// 自定义一个。把一个普通的异步方法转为promise的方法</span>
<span class="token keyword">function</span> <span class="token function">promisify</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// filename, utf8, callback</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">...</span>args<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        err <span class="token operator">?</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 返回一个新的函数</span>
<span class="token comment">// let readFileSync = Promise.promisify(readFile) // bluebird 原生用法</span>
<span class="token keyword">let</span> readFileSync <span class="token operator">=</span> <span class="token function">promisify</span><span class="token punctuation">(</span>readFile<span class="token punctuation">)</span>
<span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'./1.txt'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="其他用法"><a href="#其他用法" class="header-anchor">#</a> 其他用法</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 其他用法</span>
<span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token comment">// 自定义一个 promisifyAll</span>
<span class="token keyword">function</span> <span class="token function">promisify</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      obj<span class="token punctuation">[</span>key <span class="token operator">+</span> <span class="token string">'Async'</span><span class="token punctuation">]</span> <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 它会遍历对象上面的所有方法，给每个方法添加一个异步方法 Async</span>
<span class="token function">promisifyAll</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>
fs<span class="token punctuation">.</span><span class="token function">readFileAsync</span><span class="token punctuation">(</span><span class="token string">'./1.txt'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="genarator-promise"><a href="#genarator-promise" class="header-anchor">#</a> genarator + promise</h2> <blockquote><p>是 async await 的原理。
用到了 co 库</p></blockquote> <h3 id="原生的方式"><a href="#原生的方式" class="header-anchor">#</a> 原生的方式</h3> <blockquote><p>也会出现迭代器的多层嵌套</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      err <span class="token operator">?</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 生成器函数, 读取3个文件</span>
<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'1.txt'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'2.txt'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'3.txt'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> c
<span class="token punctuation">}</span>
<span class="token comment">// 调用生成器，返回迭代器</span>
<span class="token keyword">let</span> it <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> r1 <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// {value:promise1 , done:false}</span>
r1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 1.txt内容</span>
  <span class="token keyword">let</span> r2 <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">// {value:promise2, done:false}</span>
  r2<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 2.txt内容</span>
    <span class="token keyword">let</span> r3 <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">// {value:promise3, done:false}</span>
    r3<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 3.txt内容</span>
      <span class="token keyword">let</span> r4 <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">// {value:'3.txt内容', done:true}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="使用-co-库来自动调用迭代器"><a href="#使用-co-库来自动调用迭代器" class="header-anchor">#</a> 使用 co 库来自动调用迭代器</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// tj 发明的 co 库, 用来帮我们自动执行迭代器</span>
<span class="token keyword">let</span> co <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'co'</span><span class="token punctuation">)</span>

<span class="token comment">// 自定义 co</span>
<span class="token keyword">function</span> <span class="token function">co</span><span class="token punctuation">(</span><span class="token parameter">gen</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> it <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 让生成器持续执行</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 自执行写法，前面加个!，后面跟个()。与(function(){})()方式作用一样</span>
    <span class="token comment">// 声明式定义 function fn(){}, 函数表达式定义 let fn=function(){}</span>
    <span class="token operator">!</span> <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token parameter">lastValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> <span class="token punctuation">{</span>
        value<span class="token punctuation">,</span>
        done
      <span class="token punctuation">}</span> <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>lastValue<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将生成器套入。自动调用迭代器</span>
<span class="token function">co</span><span class="token punctuation">(</span>read<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生成器返回值 c</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="async-await-异步终极解决方案"><a href="#async-await-异步终极解决方案" class="header-anchor">#</a> async await 异步终极解决方案</h2> <blockquote><p>其实是 generator + promise 的语法糖</p></blockquote> <p><strong>好处：</strong></p> <ul><li>写法简洁</li> <li>有很好的语义</li> <li>很好地处理异常。throw Error, return, try..catch</li></ul> <h3 id="基本使用方式"><a href="#基本使用方式" class="header-anchor">#</a> 基本使用方式</h3> <h4 id="异步方法定义"><a href="#异步方法定义" class="header-anchor">#</a> 异步方法定义</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// throw Error('模仿抛出异常')</span>
      err <span class="token operator">?</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 另外，这个readFile方法 ，也可以通过蓝鸟去写。不用自己写
  let Promise = require('bluebird')
  let readFile = Promise.promisify(readFile) 
*/</span>
</code></pre></div><h4 id="使用-async-await"><a href="#使用-async-await" class="header-anchor">#</a> 使用 async await</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 如果函数中有异步代码，前面加 async</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果异步返回的是 promise， 则加一个 await。这样就可以同步形式赋值</span>
  <span class="token comment">// 也就是说 await 之后必须是 promise</span>
  <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./1.txt'</span><span class="token punctuation">)</span>
  <span class="token comment">// 可以 try..catch</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./2.txt'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token comment">// 可以捕获到异常</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./3.txt'</span><span class="token punctuation">)</span>
  <span class="token comment">// 可以 return</span>
  <span class="token keyword">return</span> <span class="token string">'ok'</span>
<span class="token punctuation">}</span>
<span class="token comment">// 不能直接 let x = read()。返回的也是一个 promise</span>
<span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ok</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="语法糖的实现原理"><a href="#语法糖的实现原理" class="header-anchor">#</a> 语法糖的实现原理</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 语法糖的实现原理 </span>
<span class="token keyword">let</span> co <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'co'</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">co</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./1.txt'</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./2.txt'</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./3.txt'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'ok'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="多种异步方式实现的demo"><a href="#多种异步方式实现的demo" class="header-anchor">#</a> 多种异步方式实现的demo</h2> <blockquote><p>用多种异步解决方案去让三个小球执行异步运动。</p></blockquote> <h3 id="回调嵌套"><a href="#回调嵌套" class="header-anchor">#</a> 回调嵌套</h3> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>utf-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Page Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
      <span class="token selector">.ball</span> <span class="token punctuation">{</span>
        <span class="token property">height</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>
        <span class="token property">width</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>
        <span class="token property">border-radius</span><span class="token punctuation">:</span> 50%<span class="token punctuation">;</span>
        <span class="token property">border</span><span class="token punctuation">:</span> 1px solid<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token selector">.ball1</span> <span class="token punctuation">{</span>
        <span class="token property">background-color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token selector">.ball2</span> <span class="token punctuation">{</span>
        <span class="token property">background-color</span><span class="token punctuation">:</span> blue<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token selector">.ball3</span> <span class="token punctuation">{</span>
        <span class="token property">background-color</span><span class="token punctuation">:</span> yellow<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 内联样式才行 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ball ball1<span class="token punctuation">&quot;</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">=&quot;</span><span class="token attr-value"><span class="token property">margin-left</span><span class="token punctuation">:</span>0px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ball ball2<span class="token punctuation">&quot;</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">=&quot;</span><span class="token attr-value"><span class="token property">margin-left</span><span class="token punctuation">:</span>0px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ball ball3<span class="token punctuation">&quot;</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">=&quot;</span><span class="token attr-value"><span class="token property">margin-left</span><span class="token punctuation">:</span>0px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token comment">// 取到3个小球的 DOM</span>
      <span class="token keyword">let</span> ball1 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.ball1'</span><span class="token punctuation">)</span>
      <span class="token keyword">let</span> ball2 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.ball2'</span><span class="token punctuation">)</span>
      <span class="token keyword">let</span> ball3 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.ball3'</span><span class="token punctuation">)</span>

      <span class="token comment">// 异步运动方法</span>
      <span class="token keyword">function</span> <span class="token function">move</span><span class="token punctuation">(</span><span class="token parameter">ball<span class="token punctuation">,</span> target<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 先取到当前的 left 值</span>
          <span class="token keyword">let</span> left <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>ball<span class="token punctuation">.</span>style<span class="token punctuation">.</span>marginLeft<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">&lt;</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ball<span class="token punctuation">.</span>style<span class="token punctuation">.</span>marginLeft <span class="token operator">=</span> <span class="token punctuation">(</span>left <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">clearInterval</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      
      <span class="token comment">//1 回调嵌套</span>
			<span class="token function">move</span><span class="token punctuation">(</span>ball1<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">move</span><span class="token punctuation">(</span>ball2<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">move</span><span class="token punctuation">(</span>ball3<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'move over'</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span> 

    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="promise-链式调用"><a href="#promise-链式调用" class="header-anchor">#</a> promise 链式调用</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 改写异步运动方法，返回 promise</span>
<span class="token keyword">function</span> <span class="token function">move2</span><span class="token punctuation">(</span><span class="token parameter">ball<span class="token punctuation">,</span> target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>index<span class="token operator">++</span> <span class="token operator">&lt;</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ball<span class="token punctuation">.</span>style<span class="token punctuation">.</span>transform <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translateX(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px)</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">clearInterval</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// promise 链式调用</span>
<span class="token function">move2</span><span class="token punctuation">(</span>ball1<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">move2</span><span class="token punctuation">(</span>ball2<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">move2</span><span class="token punctuation">(</span>ball3<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'move over'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="generator-promise"><a href="#generator-promise" class="header-anchor">#</a> generator + promise</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 自定义 co</span>
<span class="token keyword">function</span> <span class="token function">co</span><span class="token punctuation">(</span><span class="token parameter">gen</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> it <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 让生成器持续执行</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 自执行写法，前面加个!，后面跟个()。与(function(){})()方式作用一样</span>
    <span class="token comment">// 声明式定义 function fn(){}, 函数表达式定义 let fn=function(){}</span>
    <span class="token operator">!</span> <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token parameter">lastValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> <span class="token punctuation">{</span>
        value<span class="token punctuation">,</span>
        done
      <span class="token punctuation">}</span> <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>lastValue<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 生成器</span>
<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token function">move2</span><span class="token punctuation">(</span>ball1<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
  <span class="token keyword">yield</span> <span class="token function">move2</span><span class="token punctuation">(</span>ball2<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
  <span class="token keyword">yield</span> <span class="token function">move2</span><span class="token punctuation">(</span>ball3<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 这种实现，就是 koa1 版本的用法</span>
<span class="token function">co</span><span class="token punctuation">(</span>go<span class="token punctuation">)</span>
</code></pre></div><h3 id="async-await"><a href="#async-await" class="header-anchor">#</a> async await</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 4 async await</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">move2</span><span class="token punctuation">(</span>ball1<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">move2</span><span class="token punctuation">(</span>ball2<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">move2</span><span class="token punctuation">(</span>ball3<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">go</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="补充知识"><a href="#补充知识" class="header-anchor">#</a> 补充知识</h2> <h3 id="迭代器"><a href="#迭代器" class="header-anchor">#</a> 迭代器</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 迭代器</span>
<span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token keyword">of</span> ary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="深度克隆"><a href="#深度克隆" class="header-anchor">#</a> 深度克隆</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 深度克隆</span>
<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  age<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> 
  hobby<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token string">'wjy'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token string">'xxx'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  home<span class="token operator">:</span> <span class="token punctuation">{</span>
    city<span class="token operator">:</span> <span class="token string">'xxx'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// JSON.parse 正则、函数都不支持。有局限性</span>
<span class="token keyword">let</span> obj2 <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
obj2<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">10</span>
obj2<span class="token punctuation">.</span>hobby<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
obj2<span class="token punctuation">.</span>home<span class="token punctuation">.</span>city <span class="token operator">=</span> <span class="token string">'yyy'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj2<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 克隆方法</span>
<span class="token keyword">function</span> <span class="token function">deepClone</span><span class="token punctuation">(</span><span class="token parameter">parent<span class="token punctuation">,</span> child</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  child <span class="token operator">=</span> child<span class="token operator">?</span>child<span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> parent<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        child<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>parent<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'[object Object]'</span><span class="token operator">?</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token function">deepClone</span><span class="token punctuation">(</span>parent<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> child<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        child<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> parent<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> child
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/ErrorJe/whole-stack-note/edit/gh-pages/p4/es-next/10 Promise 和 async_await.md" target="_blank" rel="noopener noreferrer">编辑文档</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">1/21/2020, 1:12:15 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/p4/es-next/09 Set 和 Map 数据结构.html" class="prev">Set 和 Map 数据结构</a></span> <span class="next"><a href="/p4/es-next/11 Proxy 和 Reflect 代理对象.html">Proxy 和 Reflect 代理对象</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.9e5917f5.js" defer></script><script src="/assets/js/2.6d170185.js" defer></script><script src="/assets/js/26.c9172401.js" defer></script>
  </body>
</html>
