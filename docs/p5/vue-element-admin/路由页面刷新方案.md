# 页面和路由刷新控制方案

当前页面自主刷新，触发 `beforeRouterUpdate` 路由守卫
触发的前提：改变路由，也就是 query 部分，加个时间戳
另外，要注意， $router.push 中不要用 path，要用 name ，不然无法传递 params 属性
## 改变 URL
### 触发钩子
不会触发 created, mounted
```javascript
this.$router.push({
  name: 'InquiryReport',
  query: { refresh: parseInt(new Date().getTime() / 1000) + '' },
  params: this.$route.params
})
```



### 假装刷新页面

也就是数据重新请求，页面状态重置
```javascript
async beforeRouteUpdate(to, from, next) {
  this.rePageState()
  await this.init()
  // 主动触发子组件的某些方法，让子组件监听，改变子组件状态
  await this.emitReIqr() 
  next()
},
```



## admin 的 tab 刷新方法（推荐）

注意不会带 router 参数，相当于重新打开了这个页面
```javascript
this.$store.dispatch('tagsView/delCachedView', this.$route).then(() => {
  const { fullPath } = this.$route
  this.$nextTick(() => {
    this.$router.replace({
      path: '/redirect' + fullPath
    })
  })
})
```



## 监听浏览器原生刷新事件
### 在 created 或 mounted 中绑定事件
```javascript
mounted() {
  const that = this // 1 注意事件绑定 , this 变为了事件对象
  window.onbeforeunload = function(e) {
    // 2 保存需要的数据到本地缓存
    const item = JSON.stringify(
      Object.keys(that.$route.params).length
      ? that.$route.params
      : that.baseInfo
    )
		
    localStorage.setItem('baseInfo', item)

    // #3 若要浏览器原生提示，就加这段
    e = e || window.event
    // 兼容IE8和Firefox 4之前的版本
    if (e) {
      e.returnValue = '关闭提示'
    }
    return '关闭提示'
  }
},
```



### 注意页面销毁时，清理事件绑定

因为 vue 单页面框架，window 也就是这整个程序。
在多页面程序中， window 就是当前页面
注意区分
```javascript
destroyed() {
  window.onbeforeunload = null
},
```



### 页面加载 created 取出缓存

> 不是每次都要取缓存，要先判断想要的数据是不是取不到


```javascript
async created() {
  // 1 判断想要的数据是否存在
  if (!Object.keys(this.$route.params).length) {

    // 2 取出缓存
    this.baseInfo = JSON.parse(localStorage.getItem('baseInfo'))
		
    // 3 处理不可预知的异常
    this.wtfError()
		
    // 4 重新加载页面数据和状态
    await this.init()
  }
},
```



## 更好的建议

其实用到上述用法，主要是为了在网页突然刷新或退出后，第二次进网页可以仍然使用缓存中的数据。
那么我们在 `beforeRouterEnter`  时，就可以把从前一个页面中的数据进行缓存。这样就不需要另外绑定什么事件。换个思路，每次只要是新数据，就可以缓存。
> 需要注意的是，该钩子可以用 next(vm => {}) 但是里面的回调是在 mounted 之后，如果用了 keep-alive ，则在 activited 之后。所以意义其实不是很大

```javascript
beforeRouteEnter(to, from, next) {
  if (Object.keys(to.params).length) {
    console.log('0 路由进来，且有参数', to)
    localStorage.setItem('baseInfo', JSON.stringify(to.params))
  }
  next()
},
```
