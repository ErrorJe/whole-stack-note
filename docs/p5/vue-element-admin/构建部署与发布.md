# 项目部署上线

## 部署流程详解

- 前端静态资源
- 后端服务器，如 nodejs 环境
- nginx 服务器
- centOS 服务器
- 数据库服务器





## 服务器知识

### 阿里云 ECS 服务器

> 虚拟化技术提供的远程服务器，容器弹性动态的

#### 购买服务器

- 初始配置
  - 包年包月
  - 服务器位置：上海（后期用 CDN）
  - CPU：单核 1GB 自己玩
  - 操作系统 centOS 6
  - 系统盘 默认 40G
- 带宽：分配公网，价格涨很快
- 安全组：默认 80 端口
- 系统配置
  - 实例名，随便改
- 订单生成，选择购买期限
- 支付



#### 管理后台

- 重置服务器密码， 重启
- 通过 `ssh` 连接服务器

```js
ssh root@公网IP
// 输入密码，此时是看不到输入的
```

> 如果连接不上要看一下 22 端口是否在安全组正常启用

- 生成 SSH 密钥，避免每次手动登录(免密登录)

```js
ssh-keygen -t rsa
// 若没生成过，一般按三次回车就完事
// 生成过的， 会提示你是否重写

ssh-copy-id -i ~/.ssh/id_rsa.pub root@公网ip
// ... 输入密码，出现 `number if keys add`
// 表示这个 ip 以后就是免密登录了

// 之后每次只要输入ip地址就可以免密登录
ssh root@公网 ip
```

- 修改 hosts 文件实现快速登录

```js
sudo vim /etc/hosts

// 输入服务器 ip 和映射的名
公网ip myService

// 之后就可以直接连接这个名字
ssh root@myService
```



#### 常用指令

```js
who // 登录者
```



还有关于远程服务器自动断开连接的问题

> 阿里云服务器可能在你不操作的几分钟就会自动断开连接，所以我们要去开启自动连接的配置

```js
// 主要是去改配置文件
vim /etc/ssh/sshd_config

// 找打字段 ClientAliveinterval
// 关掉注释，并配置30（每30秒保持和客户端的连接）

// 刷新配置文件让其生效
service sshd restart
```



### HTTPS 证书

阿里云找到 SSL 证书，进行购买（可以选择免费型的 SSL）

绑定域名等待审核签发

之后就可以下载密钥（是一堆文件）



### 域名注册和备案

先搜专辑喜欢的域名，去购买

然后去管理控制台进入域名管理

绑定自己的 IP 并解析

然后进行备案，不然就算解析成功，马上就会失效

按照备案流程就可以，第一次备案大概要1个月，拿到备案号，网站就合法



### NodeJS 环境

- 先安装 nvm，相当于安装器
- 然后用 nvm 去安装 node



### Nginx

#### 安装和编译

window 直接安装就行，然后在安装目录找到配置文件。

- 用 `yum` 安装 `nginx` 需要的依赖，`yum -y install pcre*`
- 继续安装， `yum -y install openssl*`
- 新建 nginx 目录 `mkdir nginx`, 并进入 `cd nginx/`
- 下载 nginx, `wget http://nginx.org/download/nginx-1.12.2.tar.gz`（linux 上的压缩格式）
- 编译，所以还需要安装一些 gcc 
  - 先解压，`tar -zxvf nginx-1.12.2.tar.gz`
  - `cd nginx-1.12-2`， 看下有哪些文件 `ll`
  - 执行文件 `.configure`
  - 编译 `make -j4`
  - 安装 `make install`
  - 读取 nginx 配置文件，看是否安装成功，`/usr/local/nginx/sbin/nginx -t`
- 软连接 `ln -s /usr/local/nginx/sbin/nginx nginx`，相当于是快捷方式
- 回到 /root 路径，然后启动 nginx
  - `nginx `启动
  - `ps -ef|grep nginx` 查看服务
  - `nginx -s stop` 停止服务



#### 配置文件

- `cd /usr/local/nginx`
- `cd conf/`
- `vim nginx.conf`

然后就可以开始按照需求配置



### FileZilla

像 FTP 一样移动本地和服务器的文件







## 前端项目打包

### 为什么要打包

因为一些语法无法在浏览器中直接使用，还有一些如 `.vue` 文件浏览器根本无法解析。

所以要利用 `webpack` 进行打包。



### 如何打包

`npm run build:prod`（`vue-cli-service build`）

执行打包指令后，就会生成 `dist` 目录文件，里面的 `index.html`就是整个单页面应用程序的主入口文件。

> 注意 index.html 中寻找静态资源路径，是在 `vue.config.js` 中配置的，包括`publicPath, assetsDir` 这两个字段的拼接而成



`npm run build`会在根目录生成 `dist` 文件夹，里面就是需要分发的前端打包后的资源



```
npm run build:prod // # 打包正式环境
npm run build:stage // # 打包预发布环境
```



另外之前配置的环境变量文件，会选用生产环境下的配置文件 `.env.production`



### 打包优化

#### 优化预览：文件体积报告

> 其关键点在于“按需加载”，无论是什么类库，还是图标都按需加载。这样打包的时候资源会小很多
>
> 若有一些问题，则可以直接在 `dist`目录下找到这个 HTML 文件，直接打开查看。

`npm run build -- --report` 打包报告，可以看各种文件和库体积占比。然后就可以按照提示访问这个报告页面，针对体积比较大的类库或者打包资源去优化。



在使用一些集成框架时，可能给你用了别的命令，所以要看文档。就比如 `vue-element-admin`就使用`npm run preview -- --report`， report.html 会出现在 dist 目录下。可以直接打开这个文件查看信息。



#### 类库的引入方式

```
// 第一种是引入了某个方法，第二个是全部引入然后选择了其中一个方法
import debounce from '/debounce'
import {debounce} from 'lodash'

// 对于 echart 也是类似的处理
import echarts from 'echartslib/echarts' // 引入核心包
import 'echarts/lib/chart/bar' // 引入 柱状图
import 'echarts/lib/component/title' // 引入标题配置组件
```



#### 优先处理打包后体积较大的包

一般来说会有这样几个包会比较大



> 可以参照这个 issue 325
>
> https://github.com/vueComponent/ant-design-vue/issues/325



- 类库的使用
- 对图标资源的打包
- moment 的语言包



#### 优化图片资源打包



##### 创建专用图标引入库



> 每个需要在加载时用到的图标都需要这样导出，所以也是比较麻烦的。
>
> 但是目前好像也没有什么其他方式，这里要仔细不要漏掉图标



```
// src/icons.js
export {
  default as SmileOutline
} from '@ant-design/icons/lib/outline/SettingOutline';
```



##### 配置 vue.config



起一个别名



```
// vue.config.js
module.exports = {
  configureWebpack: {
    resolve: {
      alias: {
        "@ant-design/icons/lib/dist$": path.resolve(__dirname, "./src/icons.js")
      }
    }
  }
};
```



#### 优化 moment 库



也是利用 webpack 插件的形式去干掉 moment 库里的语言包



```
// vue.config.js
const webpack = require('webpack')

module.exports = {
  //...
  configureWebpack: {
    plugins: [
      // 忽略所有在 moment 中的语言包
      new webpack.IgnorePlugin(/^\.\/locale$/, /moment$/),
    ],
  }
};
```



对需要用到的语言包去按需加载



```
// App.vue 按需引入中文包
import 'moment/locale/zh-cn'
```



### 什么是部署

所谓的部署，也就是把 `dist` 目录文件都复制到 `nginx` 配置的某个目录下。（`index.html` 也可以在打包后直接双击运行，如果静态资源能够被正确找到，并且接口是通的情况下。）



当然，`index.html` 要在web容器下才能真的正常运行。在任意目录双击打开网页可能没啥用，就是在本地也是要放在 nginx 目录下才行。



### 前端部署 shell

我们可以通过编写 shell 来减轻部署压力

```js
cd /root/admin/admin-fe
git pull
cnpm i
npm run build
rm -rf ~/upload/admin
mv dist ~/upload/admin
```



### Nginx 部署

> 部署只需要将最终生成的 dist 静态资源目录发布到 cdn 或者 静态资源服务器中就行ing。
>
> 现在一般用nginx作为web服务器

#### 配置 nginx

> 在 nginx 根目录下的 conf 中， nginx.conf
>
> 原本直接将整个 dist 文件复制就行，如果在 vue.config.js 配置了上下文`publicPath: 'best-practice'`，那么要 dist/best-practice/其余文件目录



```
// 1 项目根目录, 两个 \\ 是为了在 window 下转义
root C:\\Users\\xxxx\\projects\\vue\\dist

// 2 配置文件
location /best-practice {
  # 尝试访问路径所对应的文件或目录
  # 就是当访问路径不是静态资源时，会回退到这个配置路径
  # 对应了 vue 的 histroy 模式
  # 比如访问 localhost/best-practice 就是会转到 index.html
  # 因为 vue 是单页面程序，所有的路由访问其实都是在 index.html 中进行的，若不这样配置第一次进去正常后面发生页面刷新之类的就会找不到资源
  try_files $url /best-practice/index.html
}

// 3 nginx 反向代理 ，增加访问前缀
// 当接口匹配到这前缀，就在做代理转发
// 多个 location 是为了区分多个项目
location ^~ /user/ {
  proxy_pass http://localhost:3000
}
```



#### 启动 nginx

到 nginx 安装目录下 `start nginx`



nginx 默认端口是 80



## 后端项目部署

> 写一个 shell 脚本来执行一些服务端行为

```shell
echo '直接定位到 服务端 目录'
cd /root/wechat/node-back

echo '拉取最新代码'
git pull

echo '杀掉所有 node 服务后重启服务'
kill -9 `ps -ef|grep node|grep app.js|awk '{print $2}'`
node app.js &

echo '更新后台端'
cd /root/wechat/node-pc

echo '拉取最新代码'
git pull
node app.js &

echo 'H5 服务端'
cd /root/node-h5
node app.js &
```



