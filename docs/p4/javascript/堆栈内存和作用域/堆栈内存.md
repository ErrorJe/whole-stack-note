# 堆栈内存机制

> 也是 V8 引擎做的事情

### 存储数据类型的堆栈

#### JS 中的堆（heap）栈（stack）概念

- 栈内存：提供代码运行环境，存储基本类型值
- 堆内存：提供引用类型存储的空间，存储相应的代码字符串
- 值存储区（变量对象 VO —— Varibale Object）：用来存储变量名



#### 基本类型的栈

> 其实都是指针引用

基本类型的 `等号赋值`实际上要走三步：

1. 在 `VO` 中创建变量
1. 在 `栈` 中创建值
1. 将变量和值进行关联

```javascript
let a = 0 // 在 VO 创建变量 a， 在栈中创建值 0
let b = a // 在 VO 创建变量 b， 指向上面那个 0
// b=b+1=0+1 ，栈里存入一个 1，基本类型只能关联一个值，所以与 0 断开，与 1 联系
b++
alert(a) // '0'， alert 都会用 toString 输出
```



#### 引用类型的堆

表示堆内存的地址，是一个十六进制的字符

```javascript
// 在 VO 中创建 o 变量，在堆（heap）中创建一个内存块，并把指向该内存块的地址存入栈中
let o = {}
0.a = 0 // 在该内存卡中创建 a 属性，并赋值 0
let b = o // b 一样指向 o 的堆内存地址
b.a = 10 // 把原本为 0 的 a 值改为了 10
alert(o.a) // '10'
```



#### 阿里面试题分析

第一步，创建 `a` 变量，创建在堆中创建 `n` 属性并赋值 `1` ，最后把该堆内存地址放入栈中，并与变量 `a` 进行关联。
第二步，创建变量 `b` 同时指向了该地址
![](https://raw.githubusercontent.com/ErrorJe/ErrorJE.github.io/images/img/20200119112034.png)



然后我们再来看看，第三行代码在堆栈中是如何操作的。， `a.x = a = {n:2}` 

一般的思路理解，就是等式 `从右向左` 执行，但实际上:

> 找到 a 和 a.x 的指针。如果已有指针，那么不改变它。如果没有指针，即那个变量还没被申明，那么就创建它，指向 null
> 也就是，所有的赋值操作，其实就是先创建值，在创建变量，最后依次指向

- 因为已经有 `a` 变量，所以，不会再次进行变量创建。
- 但是 `a.x` 是没有的，所以要先创建。于是在原有的堆中增加了 x 属性
- 最后让 a, a.x 都指向新的内存

![](https://raw.githubusercontent.com/ErrorJe/ErrorJE.github.io/images/img/20200119112047.png)

```javascript
let a = {
  n: 1
}
let b = a
// 第三行代码
a.x = a = {
  n:2
}
console.log(a.x) // undefined。因为此时 a 指向的是新的堆内存，其中并没有 x 属性
console.log(b) // {n:1,x:{n:2}}。b 指向的是原有 a 的堆内存
```


